# CAN总线笔记

##CAN简介&硬件电路

广播式传输方式：

一个设备发送数据，其他所有设备都能收到，它们根据报文ID来决定用不用这个数据



硬件部分：

终端电阻的作用：

1、防止回波反射（如果不加终端电阻，信号波形会在线路终端反射，进而干扰原始信号，当信号跳变时，它会在边沿振荡几下，这会干扰数据的正确传输，如果加了终端电阻且阻抗匹配，则信号的跳变沿会变得非常平稳）

2、将两根线“收紧”至电压一致状态（即默认的1状态）



## 帧格式

报文ID优先级：

根据仲裁规则，ID小的报文优先发送，ID大的报文等待下一次总线空闲再重试发送



标准格式：

RTR:远程请求标志位，用于区分数据帧还是遥控帧，数据帧必须为显性0，遥控帧必须为隐性1

数据帧和遥控帧的ID是可以相同的，数据帧的优先级大于遥控帧

IDE：ID拓展标志位，用于区分是标准格式还是拓展格式

r0：保留位，用于区分原有版本和升级版本

DLC:表示数据段的长度

ACK段：接收方操作，先拉开总线变成显性0电平告诉发送方收到数据之后释再放总线以避免长时间占用总线资源卡死

（ACK作为整个数据帧发送的环节之一即发送方和接收方共同完成一整个波形，ACK槽时可以允许多个接收方共同拉开总线）

EOF：帧结束



拓展格式：

SRR：替代RTR的位，（仲裁是先比较ID，再比较RTR，所以RTR必须在所有ID位的后面），为了保证仲裁优先级原则这一位必须给隐性1

拓展格式的IDE是隐性1

SRR+IDE的目的是为了兼容标准格式



标准格式的优先级高于拓展格式



位填充：

CAN总线规定，当总线出现连续11个隐性1后，即认为总线空闲

 

## 位同步

位时序：

定义位时序的目的是为了便于确定采样点的位置，是为了同步的

最小时间单位可以直接在程序中指定，是自己确定的

除了SS段是固定的，其他PTS,PBS1,PBS2都可以由自己在一个范围内指定



SJW指的是补偿宽度最大值，也就是说如果误差为2tq，然后设置了SJW为3tq，那么实际补偿则为2tq，而如果SJW为1tq，则实际补偿为1tq，这么做的目的是在于防止补偿过大而造成二进制数据读取出错的问题



## 仲裁

先占先得：

CAN中只有响应优先级没有抢占优先级



非破坏性仲裁：

前提条件：多个设备同时有发送需求

ID号+RTR是仲裁的依据

回读的目的：防止数据在发送后被别的设备发送的数据损坏导致无法仲裁的情况



## 错误处理

所有设备默认为主动错误状态，如果设备持续抽风的情况下，它会从

主动错误状态 -> 被动错误状态 -> 总线关闭状态

状态切换通过TEC和REC决定

TEC：Transmit Error Counter，发送错误计数器，设备在发送时，每发现一个错误，这个TEC就会增加一次，而每进行一次正常的发送后，TEC也会减小一次

REC：Receive Error Counter，接收错误计数器，设备在接收时，每发现一个错误，这个REC就会增加一次，而每进行一次正常的接收后，REC也会减小一次



## STM32-CAN外设（上）

程序通过读写寄存器来操纵电路的运行



互联型设备里的CAN1和CAN2不是独立的两个资源，是CAN2辅助CAN1工作

CAN_TX是输出，引脚控制权在CAN外设，需要配置为复用推挽输出模式

CAN_TX是输入，可以配置为上拉输入

设计3个发送邮箱的目的：为了避免短暂的拥堵（报文一直等不到总线空闲卡在邮箱里发送不出去的情况），造成CPU等待

先发送哪个邮箱里的内容可以配置

接收FIFO是否锁定可配置，锁定则丢弃准备进FIFO的新报文，不锁定则踢掉原邮箱2里的内容，自己占据邮箱2



## STM32-CAN外设（下）

标识符过滤器

2个32位过滤器—标识符列表：

该模式下，R1和R2两个寄存器可以各自写入一个标准ID或者拓展ID，也就是说过滤器一次可以过滤最多两个ID号

**但是如果出现了一次需要传输多个标准ID的情况下，这个方式有点浪费寄存器的空间（原本留给拓展ID后18位的位置直接不用），所以可以用下面这个方式去优化**



4个16位过滤器—标识符列表：

将R1和R2两个寄存器各自拆成两个16位寄存器，这样一次就可以传入4个标准ID，效率大大提高了



1个32位过滤器—标识符屏蔽

**用于数据较多的情况**，将所有需要的数据高三位全部设置为一致的写入到屏蔽寄存器中即可快速过滤出前三位相同的数据（类似子网掩码的概念，可以去了解）



2个16位过滤器—标识符屏蔽

和上面4个16位过滤器的功能类似



