# **PX4æºç è§£è¯»**

## **srcæ–‡ä»¶**

### **modules/mc_att_control/mc_att_control_main.cpp**

**æ¯ä¸ªä¸»è¦å‡½æ•°çš„ä½œç”¨æ€»ç»“**ï¼š

---

1. `MulticopterAttitudeControl::MulticopterAttitudeControl(bool vtol)`

æ„é€ å‡½æ•°ã€‚åˆå§‹åŒ–å‚æ•°ã€å·¥ä½œé˜Ÿåˆ—ã€è¯é¢˜å‘å¸ƒè€…ã€æ€§èƒ½ç»Ÿè®¡å¯¹è±¡ç­‰ï¼Œå¹¶è®¾ç½® VTOLï¼ˆå‚ç›´èµ·é™ï¼‰æ¨¡å¼ã€‚

---

2. `MulticopterAttitudeControl::~MulticopterAttitudeControl()`

ææ„å‡½æ•°ã€‚é‡Šæ”¾æ€§èƒ½ç»Ÿè®¡å¯¹è±¡ç­‰èµ„æºã€‚

---

3. `bool MulticopterAttitudeControl::init()`

åˆå§‹åŒ–å‡½æ•°ã€‚æ³¨å†Œå§¿æ€è¯é¢˜çš„å›è°ƒï¼Œåˆå§‹åŒ–æˆåŠŸè¿”å› `true`ï¼Œå¤±è´¥è¿”å› `false`ã€‚

---

4. `void MulticopterAttitudeControl::parameters_updated()`

å‚æ•°æ›´æ–°å‡½æ•°ã€‚å°†å‚æ•°å€¼å­˜å‚¨åˆ°æ›´æ–¹ä¾¿ä½¿ç”¨çš„å˜é‡ä¸­ï¼Œå¹¶é¢„è®¡ç®—å¸¸ç”¨å€¼ï¼ˆå¦‚ PID å¢ç›Šã€è§’é€Ÿåº¦é™åˆ¶ã€æœ€å¤§å€¾æ–œè§’ç­‰ï¼‰ã€‚

---

5. `float MulticopterAttitudeControl::throttle_curve(float throttle_stick_input)`

æ²¹é—¨æ›²çº¿å‡½æ•°ã€‚æ ¹æ®æ²¹é—¨æ†è¾“å…¥å’Œå‚æ•°ï¼Œè®¡ç®—å®é™…æ¨åŠ›è¾“å‡ºï¼Œå®ç°æ²¹é—¨çº¿æ€§æˆ–éçº¿æ€§æ˜ å°„ï¼Œå¹¶é™åˆ¶æœ€å¤§/æœ€å°å€¼ã€‚

---

6. `void MulticopterAttitudeControl::generate_attitude_setpoint(const Quatf &q, float dt, bool reset_yaw_sp)`

ç”Ÿæˆå§¿æ€è®¾å®šã€‚æ ¹æ®å½“å‰å§¿æ€ã€æ‰‹åŠ¨è¾“å…¥å’Œå‚æ•°ï¼Œè®¡ç®—ç›®æ ‡å§¿æ€ï¼ˆå››å…ƒæ•°å’Œæ¬§æ‹‰è§’ï¼‰åŠæ¨åŠ›ï¼Œå¹¶å‘å¸ƒåˆ°è¯é¢˜ã€‚

---

7. `void MulticopterAttitudeControl::Run()`

ä¸»å¾ªç¯å‡½æ•°ã€‚æ¯æ¬¡æœ‰æ–°å§¿æ€æ•°æ®æ—¶è¢«è°ƒç”¨ï¼Œå®Œæˆå‚æ•°æ›´æ–°ã€çŠ¶æ€åˆ¤æ–­ã€å§¿æ€è®¾å®šç”Ÿæˆã€è§’é€Ÿåº¦è®¾å®šè®¡ç®—ä¸å‘å¸ƒã€æ²¹é—¨é™åˆ¶è°ƒæ•´ç­‰æ ¸å¿ƒæ§åˆ¶é€»è¾‘ã€‚

---

8. `int MulticopterAttitudeControl::task_spawn(int argc, char *argv[])`

ä»»åŠ¡å¯åŠ¨å‡½æ•°ã€‚æ ¹æ®å‘½ä»¤è¡Œå‚æ•°åˆ›å»ºæ§åˆ¶å™¨å®ä¾‹ï¼Œåˆå§‹åŒ–å¹¶æ³¨å†Œåˆ° PX4 å·¥ä½œé˜Ÿåˆ—ï¼Œæ”¯æŒ VTOL æ¨¡å¼ã€‚

---

9. `int MulticopterAttitudeControl::custom_command(int argc, char *argv[])`

è‡ªå®šä¹‰å‘½ä»¤å¤„ç†å‡½æ•°ã€‚å½“å‰å®ç°ä¸ºé‡åˆ°æœªçŸ¥å‘½ä»¤æ—¶æ‰“å°ç”¨æ³•è¯´æ˜ã€‚

---

10. `int MulticopterAttitudeControl::print_usage(const char *reason)`

æ‰“å°ç”¨æ³•è¯´æ˜ã€‚è¾“å‡ºæ¨¡å—åŠŸèƒ½æè¿°ã€å‘½ä»¤è¡Œå‚æ•°è¯´æ˜ã€ç›¸å…³æ–‡æ¡£é“¾æ¥ç­‰ï¼Œå¸®åŠ©ç”¨æˆ·æ­£ç¡®ä½¿ç”¨æ¨¡å—ã€‚

---

11. `extern "C" __EXPORT int mc_att_control_main(int argc, char *argv[])`

æ¨¡å—ä¸»å…¥å£å‡½æ•°ã€‚ä¾› PX4 æ¡†æ¶è°ƒç”¨ï¼Œå®é™…è°ƒç”¨æ§åˆ¶å™¨ä¸»ç±»çš„ `main` æ–¹æ³•å¯åŠ¨æ¨¡å—ã€‚



------



### **modules/mc_pos_control/GotoControl/GotoControl.cpp**

**æ¯ä¸ªä¸»è¦å‡½æ•°çš„ä½œç”¨æ€»ç»“**ï¼š

---

1. `bool GotoControl::checkForSetpoint(const hrt_abstime &now, const bool enabled)`

æ£€æŸ¥æ˜¯å¦æœ‰æ–°çš„â€œGotoâ€ç›®æ ‡ç‚¹è®¾å®šéœ€è¦æ‰§è¡Œã€‚  
- åˆ¤æ–­ç›®æ ‡ç‚¹æ¶ˆæ¯æ˜¯å¦æœ‰æ•ˆã€æ˜¯å¦è¶…æ—¶ã€æ¨¡å—æ˜¯å¦ä½¿èƒ½ã€‚  
- å¦‚æœä¸éœ€è¦æ‰§è¡Œï¼Œé‡ç½®åˆå§‹åŒ–æ ‡å¿—ã€‚  
- è¿”å›æ˜¯å¦éœ€è¦è¿è¡Œ Goto æ§åˆ¶ã€‚

---

2. `void GotoControl::update(const float dt, const matrix::Vector3f &position, const float heading)`

ä¸»æ›´æ–°å‡½æ•°ã€‚  
- å¦‚æœæœªåˆå§‹åŒ–ï¼Œé‡ç½®ä½ç½®/èˆªå‘å¹³æ»‘å™¨ã€‚
- æ£€æŸ¥ç›®æ ‡ç‚¹å’Œå½“å‰ä½ç½®æ˜¯å¦åˆæ³•ã€‚
- è®¾ç½®å¹³æ»‘å™¨å‚æ•°é™åˆ¶ã€‚
- ç”Ÿæˆå¹³æ»‘çš„ä½ç½®ã€é€Ÿåº¦ã€åŠ é€Ÿåº¦ã€åŠ åŠ é€Ÿåº¦ï¼ˆjerkï¼‰è®¾å®šç‚¹ã€‚
- å¦‚æœéœ€è¦æ§åˆ¶èˆªå‘ï¼Œåˆ™å¹³æ»‘èˆªå‘å¹¶ç”Ÿæˆèˆªå‘/èˆªå‘é€Ÿåº¦è®¾å®šç‚¹ã€‚
- å‘å¸ƒè½¨è¿¹è®¾å®šç‚¹å’Œçº¦æŸæ¶ˆæ¯ã€‚

---

3. `void GotoControl::resetPositionSmoother(const matrix::Vector3f &position)`

é‡ç½®ä½ç½®å¹³æ»‘å™¨ã€‚  
- ç”¨å½“å‰åŠ é€Ÿåº¦ã€é€Ÿåº¦ã€ä½ç½®åˆå§‹åŒ–ä½ç½®å¹³æ»‘å™¨ã€‚
- æ ‡è®°ä¸å†éœ€è¦é‡ç½®ã€‚

---

4. `void GotoControl::resetHeadingSmoother(const float heading)`

é‡ç½®èˆªå‘å¹³æ»‘å™¨ã€‚  
- ç”¨å½“å‰èˆªå‘å’Œèˆªå‘é€Ÿç‡åˆå§‹åŒ–èˆªå‘å¹³æ»‘å™¨ã€‚
- å¦‚æœèˆªå‘æ— æ•ˆï¼Œåœæ­¢æ§åˆ¶èˆªå‘ã€‚

---

5. `void GotoControl::setPositionSmootherLimits(const goto_setpoint_s &goto_setpoint)`

è®¾ç½®ä½ç½®å¹³æ»‘å™¨çš„é€Ÿåº¦å’ŒåŠ é€Ÿåº¦é™åˆ¶ã€‚  
- æ ¹æ®ç›®æ ‡ç‚¹æ¶ˆæ¯å’Œå‚æ•°ï¼Œè®¾ç½®æ°´å¹³å’Œå‚ç›´æ–¹å‘çš„æœ€å¤§é€Ÿåº¦ã€åŠ é€Ÿåº¦ã€‚
- æ”¯æŒæ ¹æ®ç›®æ ‡ç‚¹åŠ¨æ€è°ƒæ•´é™åˆ¶ï¼Œå®ç°å¹³æ»‘åŠ¨æ€ã€‚

---

6. `void GotoControl::setHeadingSmootherLimits(const goto_setpoint_s &goto_setpoint)`

è®¾ç½®èˆªå‘å¹³æ»‘å™¨çš„é€Ÿç‡å’ŒåŠ é€Ÿåº¦é™åˆ¶ã€‚  
- æ ¹æ®ç›®æ ‡ç‚¹æ¶ˆæ¯å’Œå‚æ•°ï¼Œè®¾ç½®æœ€å¤§èˆªå‘é€Ÿç‡å’ŒåŠ é€Ÿåº¦ã€‚
- æ”¯æŒæ ¹æ®ç›®æ ‡ç‚¹åŠ¨æ€è°ƒæ•´é™åˆ¶ï¼Œå®ç°å¹³æ»‘èˆªå‘å˜åŒ–ã€‚



------



### **modules/mc_pos_control/PositionControl/PositionControl.cpp**

**æ¯ä¸ªä¸»è¦å‡½æ•°çš„ä½œç”¨æ€»ç»“**ï¼š

---

1. `setVelocityGains(const Vector3f &P, const Vector3f &I, const Vector3f &D)`

è®¾ç½®é€Ÿåº¦æ§åˆ¶å™¨çš„ PID å¢ç›Šå‚æ•°ï¼ˆæ¯”ä¾‹ã€ç§¯åˆ†ã€å¾®åˆ†ï¼‰ã€‚

---

2. `setVelocityLimits(const float vel_horizontal, const float vel_up, const float vel_down)`

è®¾ç½®æ°´å¹³ã€ä¸Šå‡ã€ä¸‹é™çš„æœ€å¤§é€Ÿåº¦é™åˆ¶ã€‚

---

3. `setThrustLimits(const float min, const float max)`

è®¾ç½®æ¨åŠ›çš„æœ€å°å€¼å’Œæœ€å¤§å€¼é™åˆ¶ï¼Œä¿è¯æ¨åŠ›è¾“å‡ºåœ¨å®‰å…¨èŒƒå›´å†…ã€‚

---

4. `setHorizontalThrustMargin(const float margin)`

è®¾ç½®æ°´å¹³æ–¹å‘æ¨åŠ›çš„å®‰å…¨è£•åº¦ï¼Œé˜²æ­¢æ¨åŠ›åˆ†é…æ—¶å½±å“å‚ç›´æ§åˆ¶ã€‚

---

5. `updateHoverThrust(const float hover_thrust_new)`

æ›´æ–°æ‚¬åœæ¨åŠ›å‚æ•°ï¼Œå¹¶å¯¹ç§¯åˆ†å™¨åšè¡¥å¿ï¼Œä¿è¯åˆ‡æ¢æ—¶æ¨åŠ›è¿ç»­ã€‚

---

6. `setState(const PositionControlStates &states)`

è®¾ç½®å½“å‰æ— äººæœºçš„ä½ç½®ã€é€Ÿåº¦ã€åŠ é€Ÿåº¦ã€èˆªå‘ç­‰çŠ¶æ€ã€‚

---

7. `setInputSetpoint(const trajectory_setpoint_s &setpoint)`

è®¾ç½®æœŸæœ›çš„è½¨è¿¹ç‚¹ï¼ˆä½ç½®ã€é€Ÿåº¦ã€åŠ é€Ÿåº¦ã€èˆªå‘ç­‰è®¾å®šå€¼ï¼‰ã€‚

---

8. `bool update(const float dt)`

ä¸»æ§åˆ¶æµç¨‹ã€‚  
- æ£€æŸ¥è¾“å…¥æœ‰æ•ˆæ€§ï¼›
- æ‰§è¡Œä½ç½®æ§åˆ¶å’Œé€Ÿåº¦æ§åˆ¶ï¼›
- è®¡ç®—åŠ é€Ÿåº¦å’Œæ¨åŠ›è®¾å®šï¼›
- è¿”å›è¾“å‡ºæ˜¯å¦æœ‰æ•ˆã€‚

---

9. `_positionControl()`

ä½ç½®æ§åˆ¶å™¨ï¼ˆP æ§åˆ¶ï¼‰ï¼Œæ ¹æ®ä½ç½®è¯¯å·®ç”Ÿæˆé€Ÿåº¦è®¾å®šï¼Œå¹¶åšé€Ÿåº¦çº¦æŸã€‚

---

10. `_velocityControl(const float dt)`

é€Ÿåº¦æ§åˆ¶å™¨ï¼ˆPID æ§åˆ¶ï¼‰ï¼Œæ ¹æ®é€Ÿåº¦è¯¯å·®ç”ŸæˆåŠ é€Ÿåº¦è®¾å®šï¼Œå¹¶åšæ¨åŠ›åˆ†é…ã€é¥±å’Œå¤„ç†å’ŒæŠ—ç§¯åˆ†é¥±å’Œã€‚

---

11. `_accelerationControl()`

åŠ é€Ÿåº¦æ§åˆ¶ä¸æ¨åŠ›åˆ†é…ã€‚  
- è®¡ç®—æœŸæœ›çš„æœºä½“æœå‘å’Œæ¨åŠ›å¤§å°ï¼›
- é™åˆ¶æœ€å¤§å€¾æ–œè§’å’Œæ¨åŠ›ï¼›
- ç”Ÿæˆæœ€ç»ˆæ¨åŠ›å‘é‡ã€‚

---

12. `_inputValid()`

æ£€æŸ¥è¾“å…¥è®¾å®šå’ŒçŠ¶æ€æ˜¯å¦æœ‰æ•ˆï¼ˆå¦‚ NAN æ£€æŸ¥ã€é…å¯¹æ£€æŸ¥ç­‰ï¼‰ã€‚

---

13. `getLocalPositionSetpoint(vehicle_local_position_setpoint_s &local_position_setpoint) const`

è·å–æœ¬åœ°ä½ç½®è®¾å®šç‚¹ï¼ˆç”¨äºä¸‹æ¸¸æ¨¡å—æˆ–æ—¥å¿—ï¼‰ã€‚

---

14. `getAttitudeSetpoint(vehicle_attitude_setpoint_s &attitude_setpoint) const`

æ ¹æ®æ¨åŠ›å’ŒæœŸæœ›èˆªå‘ï¼Œç”Ÿæˆå§¿æ€è®¾å®šç‚¹ï¼ˆç”¨äºå§¿æ€æ§åˆ¶å™¨ï¼‰ã€‚



------



### **modules/mavlink/mavlink_main.cpp**

**æ¯ä¸ªä¸»è¦å‡½æ•°çš„ä½œç”¨æ€»ç»“**ï¼š

è¿™ä¸ªæ–‡ä»¶æ˜¯ä¸€ä¸ªå®ç° MAVLink åè®®çš„ C++ ç¨‹åºï¼Œä¸»è¦ç”¨äºæ— äººæœºç³»ç»Ÿä¸­çš„é€šä¿¡ã€‚æ–‡ä»¶ä¸­åŒ…å«å¤šä¸ªå‡½æ•°ï¼Œæ¯ä¸ªå‡½æ•°éƒ½æœ‰ç‰¹å®šçš„åŠŸèƒ½ã€‚ä»¥ä¸‹æ˜¯è¿™äº›å‡½æ•°çš„æ€»ç»“ï¼š

#### **1. ä¸»å‡½æ•°å’Œæ¨¡å—åˆå§‹åŒ–**
- **`mavlink_main`**: ç¨‹åºçš„å…¥å£å‡½æ•°ï¼Œæ ¹æ®ä¼ å…¥çš„å‘½ä»¤è¡Œå‚æ•°è°ƒç”¨ä¸åŒçš„åŠŸèƒ½æ¨¡å—ï¼ˆå¦‚å¯åŠ¨ã€åœæ­¢ã€çŠ¶æ€æ˜¾ç¤ºç­‰ï¼‰ã€‚
- **`Mavlink::start`**: å¯åŠ¨ä¸€ä¸ªæ–°çš„ MAVLink å®ä¾‹ã€‚æ ¹æ®ä¼ å…¥çš„å‚æ•°ï¼ˆå¦‚è®¾å¤‡åã€æ³¢ç‰¹ç‡ã€æ•°æ®ç‡ç­‰ï¼‰åˆå§‹åŒ– MAVLink æ¨¡å—ï¼Œå¹¶å¯åŠ¨æ¥æ”¶å’Œå‘é€çº¿ç¨‹ã€‚
- **`Mavlink::start_helper`**: å®é™…å¯åŠ¨ MAVLink å®ä¾‹çš„è¾…åŠ©å‡½æ•°ï¼Œç”¨äºåœ¨å•ç‹¬çš„çº¿ç¨‹ä¸­è¿è¡Œ `task_main`ã€‚

#### **2. MAVLink å®ä¾‹çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†**
- **`Mavlink::Mavlink`**: MAVLink ç±»çš„æ„é€ å‡½æ•°ï¼Œåˆå§‹åŒ–å‚æ•°ã€è®¾ç½®ç³»ç»Ÿå’Œç»„ä»¶ IDï¼Œå¹¶åˆå§‹åŒ– uORB è®¢é˜…ã€‚

- **`Mavlink::~Mavlink`**: MAVLink ç±»çš„ææ„å‡½æ•°ï¼Œè´Ÿè´£æ¸…ç†èµ„æºï¼Œåœæ­¢çº¿ç¨‹ï¼Œå¹¶åˆ é™¤å®ä¾‹ã€‚

- **`Mavlink::destroy_all_instances`**: åœæ­¢å¹¶é”€æ¯æ‰€æœ‰ MAVLink å®ä¾‹ï¼Œç¡®ä¿æ‰€æœ‰çº¿ç¨‹å®‰å…¨é€€å‡ºã€‚

- **`Mavlink::stop_command`**: åœæ­¢ä¸€ä¸ªæŒ‡å®šçš„ MAVLink å®ä¾‹ï¼Œé€šè¿‡è®¾å¤‡åæˆ–ç½‘ç»œç«¯å£æŸ¥æ‰¾å®ä¾‹å¹¶è¯·æ±‚åœæ­¢ã€‚

  psï¼šä½¿ç”¨ä¸¤ä¸ªåˆ é™¤å®ä¾‹å‡½æ•°çš„åŸå› 

  ææ„å‡½æ•°è´Ÿè´£â€œå•ä¸ªå®ä¾‹â€çš„æ¸…ç†ï¼Œè€Œ `destroy_all_instances()` è´Ÿè´£â€œå…¨å±€ç®¡ç†å¤šä¸ªå®ä¾‹çš„ç»Ÿä¸€é”€æ¯â€ã€‚

#### **3. å‚æ•°å’ŒçŠ¶æ€ç®¡ç†**
- **`Mavlink::mavlink_update_parameters`**: æ›´æ–° MAVLink æ¨¡å—çš„å‚æ•°ï¼Œå¦‚åè®®ç‰ˆæœ¬ã€æ•°æ®ç‡ç­‰ã€‚
- **`Mavlink::set_channel`**: æ ¹æ®å®ä¾‹ ID è®¾ç½® MAVLink é€šé“ã€‚
- **`Mavlink::set_instance_id`**: ä¸ºæ–°çš„ MAVLink å®ä¾‹åˆ†é…ä¸€ä¸ªå”¯ä¸€çš„å®ä¾‹ IDã€‚
- **`Mavlink::set_proto_version`**: è®¾ç½® MAVLink åè®®ç‰ˆæœ¬ï¼ˆ1 æˆ– 2ï¼‰ã€‚
- **`Mavlink::configure_streams_to_default`**: æ ¹æ®æ¨¡å¼ï¼ˆå¦‚æ­£å¸¸ã€ä½å¸¦å®½ã€OSD ç­‰ï¼‰é…ç½®é»˜è®¤çš„ MAVLink æ•°æ®æµã€‚
- **`Mavlink::configure_stream`**: é…ç½®å•ä¸ª MAVLink æ•°æ®æµçš„å‘é€é¢‘ç‡ã€‚
- **`Mavlink::configure_stream_threadsafe`**: çº¿ç¨‹å®‰å…¨åœ°é…ç½®å•ä¸ª MAVLink æ•°æ®æµã€‚

#### **4. é€šä¿¡åŠŸèƒ½**
- **`Mavlink::mavlink_open_uart`**: æ‰“å¼€ä¸²è¡Œç«¯å£ï¼Œè®¾ç½®æ³¢ç‰¹ç‡å’Œæµæ§åˆ¶ã€‚
- **`Mavlink::setup_flow_control`**: è®¾ç½®ç¡¬ä»¶æµæ§åˆ¶æ¨¡å¼ã€‚
- **`Mavlink::send_start`ã€`send_finish`ã€`send_bytes`**: ç”¨äºå‘é€æ•°æ®çš„å‡½æ•°ï¼Œç®¡ç†å‘é€ç¼“å†²åŒºå’Œé”™è¯¯å¤„ç†ã€‚
- **`Mavlink::handle_message`**: å¤„ç†æ¥æ”¶åˆ°çš„ MAVLink æ¶ˆæ¯ï¼Œå¦‚è½¬å‘æ¶ˆæ¯æˆ–æ›´æ–°çŠ¶æ€ã€‚
- **`Mavlink::forward_message`**: å°†æ¶ˆæ¯è½¬å‘åˆ°å…¶ä»– MAVLink å®ä¾‹ã€‚
- **`Mavlink::send_autopilot_capabilities`**: å‘é€è‡ªåŠ¨é©¾é©¶ä»ªåŠŸèƒ½ä¿¡æ¯ã€‚
- **`Mavlink::send_protocol_version`**: å‘é€å½“å‰çš„ MAVLink åè®®ç‰ˆæœ¬ä¿¡æ¯ã€‚

#### **5. çŠ¶æ€å’Œè°ƒè¯•**
- **`Mavlink::display_status`**: æ˜¾ç¤º MAVLink å®ä¾‹çš„çŠ¶æ€ä¿¡æ¯ï¼ŒåŒ…æ‹¬æ•°æ®ç‡ã€æµæ§åˆ¶ã€è¿æ¥çŠ¶æ€ç­‰ã€‚
- **`Mavlink::display_status_streams`**: æ˜¾ç¤ºå½“å‰é…ç½®çš„æ•°æ®æµåŠå…¶å‘é€é¢‘ç‡ã€‚
- **`Mavlink::publish_telemetry_status`**: å‘å¸ƒ MAVLink çš„é¥æµ‹çŠ¶æ€ä¿¡æ¯åˆ° uORBã€‚

#### **6. äº‹ä»¶å’Œæ—¥å¿—**
- **`Mavlink::send_statustext_info`ã€`send_statustext_critical`ã€`send_statustext_emergency`**: å‘é€ä¸åŒçº§åˆ«çš„çŠ¶æ€æ–‡æœ¬æ¶ˆæ¯ã€‚
- **`Mavlink::handle_event`**: å¤„ç†äº‹ä»¶ï¼Œå¦‚å°†äº‹ä»¶å‘é€åˆ° MAVLinkã€‚

#### **7. å…¶ä»–åŠŸèƒ½**
- **`Mavlink::set_hil_enabled`**: å¯ç”¨æˆ–ç¦ç”¨ç¡¬ä»¶åœ¨ç¯ï¼ˆHILï¼‰æ¨¡å¼ã€‚
- **`Mavlink::update_rate_mult`**: æ ¹æ®å½“å‰æ•°æ®ç‡å’Œé“¾è·¯çŠ¶æ€åŠ¨æ€è°ƒæ•´æ•°æ®æµçš„å‘é€é¢‘ç‡ã€‚
- **`Mavlink::update_radio_status`**: æ›´æ–°æ— çº¿ç”µå°çš„çŠ¶æ€ä¿¡æ¯ã€‚
- **`Mavlink::configure_sik_radio`**: é…ç½® SIK æ— çº¿ç”µå°çš„å‚æ•°ã€‚

#### **8. å‘½ä»¤è¡Œå·¥å…·**
- **`Mavlink::stream_command`**: é€šè¿‡å‘½ä»¤è¡Œé…ç½® MAVLink æ•°æ®æµçš„å‘é€é¢‘ç‡ã€‚
- **`usage`**: æ˜¾ç¤ºå‘½ä»¤è¡Œå·¥å…·çš„ä½¿ç”¨è¯´æ˜ã€‚

#### **9. ç½‘ç»œåŠŸèƒ½ï¼ˆUDPï¼‰**
- **`Mavlink::init_udp`**: åˆå§‹åŒ– UDP å¥—æ¥å­—ã€‚
- **`Mavlink::find_broadcast_address`**: æŸ¥æ‰¾å¹¿æ’­åœ°å€ã€‚
- **`Mavlink::compute_broadcast_addr`**: è®¡ç®—å¹¿æ’­åœ°å€ã€‚
- **`Mavlink::query_netmask_addr`**: æŸ¥è¯¢ç½‘ç»œæ©ç åœ°å€ã€‚

è¿™äº›å‡½æ•°å…±åŒå®ç°äº† MAVLink åè®®çš„å®Œæ•´åŠŸèƒ½ï¼ŒåŒ…æ‹¬åˆå§‹åŒ–ã€é€šä¿¡ã€çŠ¶æ€ç®¡ç†ã€äº‹ä»¶å¤„ç†å’Œè°ƒè¯•ç­‰åŠŸèƒ½ã€‚



------



### **modules/mavlink/mavlink_receiver.cpp**

**æ¯ä¸ªä¸»è¦å‡½æ•°çš„ä½œç”¨æ€»ç»“**ï¼š

åœ¨ PX4 çš„ `mavlink_receiver.cpp` æ–‡ä»¶ä¸­ï¼Œä¸»è¦å®šä¹‰äº† `MavlinkReceiver` ç±»åŠå…¶å¤šä¸ªå‡½æ•°ï¼Œç”¨äºæ¥æ”¶å’Œå¤„ç†æ¥è‡ª MAVLink çš„å„ç±»æ¶ˆæ¯ã€‚ä»¥ä¸‹æ˜¯å¯¹æ–‡ä»¶ä¸­ä¸»è¦å‡½æ•°çš„æ€»ç»“è¯´æ˜ï¼Œå¸®åŠ©ä½ ç†è§£æ¯ä¸ªå‡½æ•°çš„ä½œç”¨ï¼š

------

#### ğŸ§© æ„é€ ä¸ææ„å‡½æ•°

- **`MavlinkReceiver::MavlinkReceiver(Mavlink \*parent)`**
   åˆå§‹åŒ– `MavlinkReceiver` å¯¹è±¡ï¼Œç»‘å®šåˆ°å¯¹åº”çš„ `Mavlink` é€šé“å®ä¾‹ï¼Œå¹¶åˆå§‹åŒ–å‡ ä¸ªå­æ¨¡å—ï¼ˆFTPã€æ—¥å¿—å¤„ç†å™¨ã€ä»»åŠ¡ç®¡ç†å™¨ã€å‚æ•°ç®¡ç†å™¨ã€æ—¶é—´åŒæ­¥ç­‰ï¼‰ã€‚
- **`~MavlinkReceiver()`**
   ææ„å‡½æ•°ï¼Œè´Ÿè´£æ¸…ç†åœ¨è¿è¡ŒæœŸé—´ç”³è¯·çš„èµ„æºï¼Œå¦‚ä¼ æ„Ÿå™¨å‘å¸ƒè€…å¯¹è±¡ã€ç»Ÿè®¡ç»“æ„ç­‰ã€‚

------

#### ğŸ” ä¸»å¾ªç¯è°ƒåº¦

- **`void MavlinkReceiver::handle_message(mavlink_message_t \*msg)`**
   è¿™æ˜¯ä¸»æ¶ˆæ¯åˆ†å‘å‡½æ•°ï¼Œæ ¹æ®æ¥æ”¶åˆ°çš„ `msgid`ï¼Œå°†æ¶ˆæ¯åˆ†å‘ç»™å¯¹åº”çš„å¤„ç†å‡½æ•°ã€‚ä¾‹å¦‚ `COMMAND_LONG` ä¼šè¢«é€åˆ° `handle_message_command_long` ä¸­å¤„ç†ã€‚

------

#### ğŸ§¾ å„ç±» MAVLink æ¶ˆæ¯å¤„ç†å‡½æ•°ï¼ˆéƒ¨åˆ†ç¤ºä¾‹ï¼‰

å‘½ä»¤ç±»

- **`handle_message_command_long()`**
   å¤„ç† MAVLink çš„ `COMMAND_LONG` å‘½ä»¤ï¼Œè§£æå‚æ•°ï¼Œè½¬åŒ–ä¸º PX4 å†…éƒ¨çš„ `vehicle_command_s` å¹¶å‘å¸ƒåˆ° uORBã€‚
- **`handle_message_command_int()`**
   ç±»ä¼¼ä¸Šé¢ï¼Œä½†ç”¨äºå¤„ç†æ•´æ•°å‹çš„ `COMMAND_INT` å‘½ä»¤ã€‚
- **`handle_message_command_ack()`**
   å¤„ç†æ¥è‡ªå¤–éƒ¨ç³»ç»Ÿçš„å‘½ä»¤åº”ç­” ACKã€‚

æ§åˆ¶ç±»

- **`handle_message_set_mode()`**
   è®¾ç½®ç³»ç»Ÿå·¥ä½œæ¨¡å¼ï¼Œæ¯”å¦‚ä» MANUAL åˆ‡æ¢åˆ° OFFBOARD æ¨¡å¼ã€‚(å®ƒçš„ä¸»è¦ä½œç”¨æ˜¯æŠŠå¤–éƒ¨çš„æ¨¡å¼åˆ‡æ¢è¯·æ±‚è½¬æ¢æˆ PX4 ç³»ç»Ÿå†…éƒ¨çš„ç»Ÿä¸€å‘½ä»¤æ ¼å¼ï¼Œå¹¶é€šè¿‡ `_cmd_pub` å‘å¸ƒå‡ºå»ã€‚å¹¶ä¸èµ·åˆ°ç›´æ¥è®¾ç½®é£è¡Œæ¨¡å¼çš„ä½œç”¨)
- **`handle_message_set_position_target_local_ned()` / `global_int()`**
   å¤„ç†å±€éƒ¨æˆ–å…¨çƒä½ç½®æ§åˆ¶ç›®æ ‡ï¼Œè½¬ä¸º PX4 çš„è½¨è¿¹ç‚¹æˆ–å§¿æ€æ§åˆ¶ã€‚
- **`handle_message_set_attitude_target()`**
   è®¾ç½®æœŸæœ›å§¿æ€ã€è§’é€Ÿåº¦ã€æ¨åŠ›ç­‰æ§åˆ¶ç›®æ ‡ã€‚

çŠ¶æ€/ä¼ æ„Ÿå™¨ç±»

- **`handle_message_radio_status()`**
   å¤„ç†æ— çº¿ç”µå°çŠ¶æ€æ¶ˆæ¯ï¼Œæ›´æ–°ä¿¡å·è´¨é‡ç­‰å‚æ•°ã€‚
- **`handle_message_distance_sensor()`**
   å¤„ç†æ¥è‡ª MAVLink çš„è·ç¦»ä¼ æ„Ÿå™¨æ•°æ®ã€‚
- **`handle_message_optical_flow_rad()`**
   å¤„ç†å…‰æµé›·è¾¾ç±»å‹çš„æ•°æ®ï¼ˆå¸¦è§’é€Ÿåº¦ï¼‰ã€‚
- **`handle_message_vision_position_estimate()` / `odometry()`**
   å¤„ç†è§†è§‰/é‡Œç¨‹è®¡ä½ç½®ä¼°è®¡ä¿¡æ¯ã€‚
- **`handle_message_hil_\*()`**
   ä¸€ç³»åˆ—ä»¥ `hil_` å¼€å¤´çš„å‡½æ•°ï¼Œç”¨äºä»¿çœŸï¼ˆHardware-In-the-Loopï¼‰æ¨¡å¼ä¸‹ä¼ æ„Ÿå™¨æ•°æ®æ³¨å…¥ã€‚

------

#### ğŸ”„ æŒ‡ä»¤åˆ¤æ–­ä¸åé¦ˆ

- **`acknowledge()`**
   å›å¤ MAVLink å‘½ä»¤æ‰§è¡Œç»“æœï¼ˆACKï¼‰ã€‚
- **`evaluate_target_ok()`**
   åˆ¤æ–­è¯¥æŒ‡ä»¤æ˜¯å¦æ˜¯å‘é€ç»™æœ¬é£æ§ç³»ç»Ÿçš„ç›®æ ‡ï¼ˆé€šè¿‡ sysid å’Œ compidï¼‰ã€‚
- **`handle_message_command_both()`**
   ä¸€ä¸ªæ¨¡æ¿å‡½æ•°ï¼Œç”¨äºå¤„ç† `COMMAND_LONG` å’Œ `COMMAND_INT` çš„é€šç”¨é€»è¾‘ï¼ŒåŒ…æ‹¬è¯·æ±‚ä¿¡æ¯ã€æ³¨å…¥æ•…éšœã€è‡ªåŠ¨è°ƒå‚ç­‰ã€‚

------

#### ğŸ” å·¥å…·/åŠŸèƒ½æ€§å‡½æ•°

- **`fill_thrust()`**
   æ ¹æ®ç³»ç»Ÿç±»å‹ï¼ˆå›ºå®šç¿¼ã€å¤šæ—‹ç¿¼ï¼‰å†³å®šæ¨åŠ›åœ¨å“ªä¸ªè½´ä¸Šè®¾ç½®ã€‚
- **`handle_request_message_command()`**
   å¤„ç†å¯¹ç‰¹å®šæ¶ˆæ¯çš„è¯·æ±‚ï¼Œå¦‚ `MAV_CMD_REQUEST_MESSAGE`ã€‚

------

è¿™äº›å‡½æ•°ä¸»è¦ä»»åŠ¡æ˜¯ä» MAVLink åè®®æ•°æ®ä¸­æå–æœ‰ç”¨ä¿¡æ¯ï¼Œå¹¶è½¬å‘æˆ–è½¬æ¢ä¸º PX4 å†…éƒ¨é€šç”¨çš„æ•°æ®ç»“æ„ï¼ˆå¦‚ uORB æ¶ˆæ¯ï¼‰ï¼Œä¾›é£æ§ç³»ç»Ÿå…¶ä»–æ¨¡å—ä½¿ç”¨ã€‚

ps:

/*
handle_message() å’Œ handle_message_command_both() çš„åŒºåˆ«ï¼š

1. ä½œç”¨å±‚çº§ï¼š
   - handle_message() æ˜¯é¡¶å±‚çš„ MAVLink æ¶ˆæ¯å¤„ç†å…¥å£ã€‚
   - handle_message_command_both() ä¸“é—¨ç”¨äºå¤„ç†ç‰¹å®šçš„å‘½ä»¤ç±»æ¶ˆæ¯ï¼ˆå¦‚ MAV_CMD_*ï¼‰ã€‚

2. å¤„ç†å†…å®¹ï¼š
   - handle_message() è´Ÿè´£è¯†åˆ«å¹¶åˆ†å‘æ‰€æœ‰ç±»å‹çš„ MAVLink æ¶ˆæ¯ã€‚
   - handle_message_command_both() ä¸“æ³¨äºå‘½ä»¤ç±»æ¶ˆæ¯çš„è§£æä¸å“åº”å¤„ç†ã€‚

3. è°ƒç”¨å…³ç³»ï¼š
   - handle_message() åœ¨è¯†åˆ«åˆ°æ¶ˆæ¯æ˜¯å‘½ä»¤ç±»æ—¶ï¼Œä¼šè°ƒç”¨ handle_message_command_both()ã€‚
   - handle_message_command_both() ä¸ä¼šä¸»åŠ¨è°ƒç”¨ handle_message()ï¼Œæ˜¯è¢«åŠ¨å¤„ç†ã€‚

4. æ¶ˆæ¯æ¥æºï¼š
   - handle_message() æ¥æ”¶åŸå§‹çš„ MAVLink æ¶ˆæ¯ï¼ˆç±»å‹ä¸º mavlink_message_tï¼‰ã€‚
   - handle_message_command_both() å¤„ç†çš„æ˜¯å·²ç»ä»æ¶ˆæ¯ä¸­è§£ç å‡ºçš„ command å¯¹è±¡ã€‚
     */
   
     

/**
 * handle_message_command_both<T>() æ˜¯ PX4 ä¸­ç”¨äºç»Ÿä¸€å¤„ç† MAVLink å‘½ä»¤ç±»æ¶ˆæ¯çš„æ¨¡æ¿å‡½æ•°ã€‚
 *
 * å®ƒå¤„ç†ä¸¤ç§ç±»å‹çš„æŒ‡ä»¤ï¼š
 * - mavlink_command_long_tï¼šå¯¹åº” MAVLink æ¶ˆæ¯ COMMAND_LONG
 * - mavlink_command_int_tï¼šå¯¹åº” MAVLink æ¶ˆæ¯ COMMAND_INT
 *
 * è¿™äº›æ¶ˆæ¯ä¼šå…ˆè¢« handle_message_command_long() æˆ– handle_message_command_int() è§£ç ï¼Œ
 * ç„¶åä¼ å…¥æœ¬å‡½æ•°ç»Ÿä¸€å¤„ç†ã€‚å®ƒä»¬ä¼šè¢«è½¬åŒ–ä¸º PX4 å†…éƒ¨çš„ vehicle_command_s ç»“æ„ä½“ï¼Œ
 * ç”¨äºç³»ç»Ÿå†…æ¨¡å—è¿›ä¸€æ­¥å¤„ç†æˆ–è½¬å‘ã€‚
 *
 * æœ¬å‡½æ•°è¿˜ä¼šæ ¹æ®å¤„ç†ç»“æœå‘é€ ACKï¼ˆç¡®è®¤å“åº”ï¼‰ï¼ŒåŒ…æ‹¬æ‰§è¡Œä¸­ã€æ‹’ç»ã€å¤±è´¥ç­‰çŠ¶æ€ã€‚
 *
 * å‚æ•°è¯´æ˜ï¼š
 * - Tï¼šè§£ç åçš„ MAVLink æŒ‡ä»¤ç»“æ„ä½“ï¼ˆmavlink_command_long_t æˆ– mavlink_command_int_tï¼‰
 * - msgï¼šåŸå§‹çš„ MAVLink æ¶ˆæ¯ï¼ˆmavlink_message_tï¼‰
 * - vehicle_commandï¼šPX4 å†…éƒ¨å‘½ä»¤è¡¨ç¤ºï¼ˆvehicle_command_sï¼‰
 */
